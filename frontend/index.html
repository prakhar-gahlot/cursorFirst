<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chat Demo</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 24px; }
    .container { max-width: 800px; margin: 0 auto; display: grid; gap: 12px; }
    .row { display: flex; gap: 8px; }
    input[type="text"] { flex: 1; padding: 10px 12px; border-radius: 8px; border: 1px solid #888; }
    button { padding: 10px 14px; border-radius: 8px; border: 1px solid #888; background: #0d6efd; color: #fff; cursor: pointer; }
    button.secondary { background: #6c757d; }
    button:disabled { opacity: 0.7; cursor: not-allowed; }
    .messages { border: 1px solid #888; border-radius: 8px; padding: 12px; min-height: 160px; white-space: pre-wrap; }
    .hint { font-size: 0.9em; color: #666; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Simple Chat</h2>
    <div class="row">
      <input id="message" type="text" placeholder="Ask something..." />
      <button id="mic" class="secondary" title="Speak your query">ðŸŽ¤</button>
      <button id="send">Send</button>
    </div>
    <div class="hint" id="api-hint">Backend: Detecting...</div>
    <div id="output" class="messages"></div>
  </div>

  <script>
    const input = document.getElementById('message');
    const sendBtn = document.getElementById('send');
    const micBtn = document.getElementById('mic');
    const output = document.getElementById('output');
    const apiHint = document.getElementById('api-hint');

    // Auto-detect API URL (production or local)
    const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
      ? 'http://localhost:8000' 
      : window.location.origin;
    
    apiHint.textContent = `Backend: POST ${API_URL}/chat`;

    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;
      setLoading(true);
      appendLine(`You: ${text}`);
      input.value = '';
      try {
        const res = await fetch(`${API_URL}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text })
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || res.statusText);
        }
        const data = await res.json();
        appendLine(`Agent: ${data.response}`);
      } catch (e) {
        appendLine(`Error: ${e.message}`);
      } finally {
        setLoading(false);
      }
    }

    function appendLine(line) {
      output.textContent += (output.textContent ? '\n' : '') + line;
      output.scrollTop = output.scrollHeight;
    }

    function setLoading(loading) {
      sendBtn.disabled = loading;
      micBtn.disabled = loading;
      input.disabled = loading;
    }

    // Speech-to-text using Web Speech API (if available)
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      micBtn.disabled = true;
      micBtn.title = 'Speech recognition not supported in this browser';
    } else {
      const recognizer = new SpeechRecognition();
      recognizer.lang = 'en-US';
      recognizer.interimResults = false;
      recognizer.maxAlternatives = 1;

      recognizer.addEventListener('result', (event) => {
        const transcript = Array.from(event.results)
          .map(r => r[0]?.transcript || '')
          .join(' ')
          .trim();
        if (transcript) {
          input.value = transcript;
        }
      });

      recognizer.addEventListener('error', (event) => {
        appendLine(`Mic error: ${event.error}`);
      });

      micBtn.addEventListener('click', () => {
        try { recognizer.start(); } catch (_) {}
      });
    }

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { sendMessage(); }
    });
    sendBtn.addEventListener('click', sendMessage);
  </script>
</body>
</html>


